extends ../_layout_report

block body
  //- - var flash = req.flash('message')
  //- if flash.length != 0
  //-   .alert.alert-danger(role='alert')
  //-     p= flash
  .container
    .row
      .col-xs-10
        h2.m-bottom-6 訂單報表
      // /col-xs-10
      .col-xs-2.text-right
        //- a(data-toggle='collapse', href='#collapse-order', aria-expanded='false')
        //-   span.glyphicon.glyphicon-zoomin.font-size-large.m-top-1
      // /col-xs-2
    // /row
    .row
      .col-md-6
        //- form.form-inline
        //-   .form-group
        //-     label 顯示
        //-     select#order-query-limit.form-control
        //-       option(selected=(limit==10)) 10
        //-       option(selected=(limit==20)) 20
        //-       option(selected=(limit==30)) 30
        //-       option(selected=(limit==40)) 40
        //-       option(selected=(limit==50)) 50
        //-     label 筆資料（共 #{orders.count} 筆）
          // /form-group
      // /col-md-6
      .col-md-6.desktop-text-right
        button.btn.btn-gray(id='print') 列印撿貨單
        //- a.btn.btn-gray(href='#') 列印清單
      // /col-md-6
    // /row

    // order-list
    hr.dashed-line
    h2 查詢結果總額： $#{ordersPaymentTotal}
    #collapse-purchase.panel-group(role='tablist', aria-multiselectable='true')
      .p-10-20
        .row.row-s.text-center.font-size-base
          //- .col-sm-1.col-sm-1-sm
          //-   input(type='checkbox')
          // /col-sm-1
          .col-sm-2 交易序號
          // /col-sm-2
          .col-sm-2 金流交易序號
          // /col-sm-2
          .col-sm-1 訂單金額
          // /col-sm-1
          .col-sm-2.col-sm-2-sm 付款確認日期
          // /col-sm-1
          .col-sm-1.col-sm-1-lg 付款金額
          // /col-sm-1
          .col-sm-2 付款方式
          // /col-sm-1
          .col-sm-1 備註
          // /col-sm-2
        // /row
      // /p-10-20
      each order in orders.rows
        .panel.panel-purchase
          .panel-heading
            .row.row-s.text-center
              //- .col-sm-1.col-sm-1-sm
              //-   input(class='printSelect',type='checkbox',value='#{order.id}')
              // /col-sm-1
              .col-sm-2
                a(data-toggle='collapse', data-parent='#collapse-purchase', href='#collapse-purchase-#{order.serialNumber}', aria-expanded='true') #{order.Allpay.TradeNo}
              // /col-sm-2
              .col-sm-2 #{order.Allpay.MerchantTradeNo}
              // /col-sm-2
              .col-sm-1 #{order.paymentTotalAmount? `$ ${order.paymentTotalAmount}` : ''}
              // /col-sm-1
              .col-sm-2.col-sm-2-sm #{sails.moment(order.paymentConfirmDate).format('YYYY/MM/DD')}
              // /col-sm-1
              .col-sm-1.col-sm-1-lg  #{order.Allpay.TradeAmt? `$ ${order.Allpay.TradeAmt}` : ''}
              // /col-sm-1
              .col-sm-2 #{allPayPaymentTypeJson[order.Allpay.PaymentType]}
              // /col-sm-1
              .col-sm-1 #{order.description}
              // /col-sm-2
            // /row
          // /panel-heading
          //- .panel-collapse.collapse(aria-expanded='true', id='collapse-purchase-#{order.serialNumber}')
            .panel-body
              .p-10
                .m-top-2.m-bottom-2
                  .row
                    .col-sm-6
                      ul.p-left-4
                        li 收件人姓名：#{order.Shipment.dataValues.username} 先生/小姐
                        li 收件人電話：#{order.Shipment.dataValues.mobile}
                        li 收件人地址：#{order.Shipment.dataValues.address}
                    // /col-sm-6
                    .col-sm-6
                      form.form-horizontal
                        .form-group.form-group-sm
                          label.col-sm-4.control-label 運送方式
                          .col-sm-8
                            input.form-control.input-sm(type='text', value='#{i18n(order.Shipment.shippingType)} #{order.Shipment.shippingRegion}') 
                        // /form-group
                        //- .form-group.form-group-sm
                        //-   label.col-sm-4.control-label 訂單編號
                        //-   .col-sm-8
                        //-     input.form-control.input-sm(type='text', value='#{order.shippingId || ""}') 
                        // /form-group
                    // /col-sm-6
                  // /row
                // /m-top-2 m-bottom-2
                .well
                  table.table.m-bottom-4.border-bottom-1
                    thead
                      tr
                          th 貨號
                          th 商品名稱
                          th.text-center 數量
                          th 單價
                          th.text-right 小計
                    tbody
                      - sumPrice = 0
                      - sum = 0
                      each item in order.OrderItems
                        tr
                          td #{item.productNumber}
                          td
                            a(href='#') #{item.name}
                          td.text-center #{item.quantity}
                          td #{item.price}
                          td.text-right #{item.price*item.quantity}
                          - sumPrice += item.price*item.quantity
                          - sum += item.quantity
                      tr
                        td(colspan='2')
                          ul.list-inline
                            if(sumPrice>390)
                              - order.Shipment.shippingFee = 0;
                              li 運費 (滿額免運)
                            else
                              li 運費 #{order.Shipment.shippingFee}
                            if(order.packingFee)
                              li 包裝 #{order.packingFee}
                            else
                              li 包裝 (無包裝費)
                            if(order.ShopCodeId)
                              li 折扣碼ID #{order.ShopCodeId}
                            else
                              li 折扣碼ID 未使用
                        td.text-center.text-danger #{sum}
                        td.text-right(colspan='2')
                          h3
                            small 總計
                            span.m-left-2 NT$ #{order.paymentTotalAmount}
                        
                  .m-left-1
                    if order.allPayPaymentType == "ATM"
                      p 付款方式：#{order.allPayPaymentType} 繳費代碼：#{order.BankCode || ''} #{order.vAccount || ''}
                    else if order.allPayPaymentType == "CVS" || order.allPayPaymentType == "BARCODE"
                      p 付款方式：#{order.allPayPaymentType} 繳費代碼：#{order.PaymentNo || ''}
                    else if order.allPayPaymentType == "Credit"
                      p 付款方式：#{order.allPayPaymentType}
                      
                    ul.list-inline
                      if order.InvoiceId
                        li 發票類型：#{order.Invoice ? i18n(order.Invoice.type) : ''}
                        li 抬頭：#{order.Invoice ? order.Invoice.title : ''}
                        li 統編：#{order.Invoice ? order.Invoice.taxId : ''}
                    p.text-danger 賣家備註：#{order.description?order.description: '無'}
                  // /m-left-1
                // /well
                .row
                  .col-sm-8
                    p.text-danger
                      | ※ 會員備註：#{order.User.comment?order.User.comment: '無'}
                  // /col-sm-8

                  if (order.status !== "orderCancel")
                    .col-sm-4.text-right
                      button.cancel-order.btn.btn-gray.btn-sm(type='button', data-id="#{order.serialNumber}") 取消整筆訂單
                  // /col-sm-4
                // /row
              // /p-10
            // /panel-body
          // /panel-collapse
        // /panel
    // /collapse-purchase

block js
  script(src='/javascripts/admin/order.js')
